<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-test/umi.css" />
    <script>
      window.routerBase = "/blog-test";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>28丨案例：带宽消耗以及Swap（下） - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/性能测试实战30讲/06.第四模块性能测试分析实战篇/03" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>前端开发<ul><li><a href="/blog-test/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li></ul></span><span>软件测试<ul><li><a href="/blog-test/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a aria-current="page" class="active" href="/blog-test/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-test/接口测试入门课">接口测试入门课</a></li><li><a href="/blog-test/程序员的测试课">程序员的测试课</a></li><li><a href="/blog-test/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog-test/软件测试52讲">软件测试52讲</a></li></ul></span><span>产品与用户体验<ul><li><a href="/blog-test/成为ai产品经理">成为ai产品经理</a></li><li><a href="/blog-test/硅谷产品实战36讲">硅谷产品实战36讲</a></li><li><a href="/blog-test/苏杰的产品创新课">苏杰的产品创新课</a></li></ul></span><span>杂谈<ul><li><a href="/blog-test/b测试从0到1">b测试从0到1</a></li><li><a href="/blog-test/tob市场品牌实战课">tob市场品牌实战课</a></li><li><a href="/blog-test/从0开始做增长">从0开始做增长</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>前端开发<ul><li><a href="/blog-test/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li></ul></li><li>软件测试<ul><li><a href="/blog-test/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a aria-current="page" class="active" href="/blog-test/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-test/接口测试入门课">接口测试入门课</a></li><li><a href="/blog-test/程序员的测试课">程序员的测试课</a></li><li><a href="/blog-test/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog-test/软件测试52讲">软件测试52讲</a></li></ul></li><li>产品与用户体验<ul><li><a href="/blog-test/成为ai产品经理">成为ai产品经理</a></li><li><a href="/blog-test/硅谷产品实战36讲">硅谷产品实战36讲</a></li><li><a href="/blog-test/苏杰的产品创新课">苏杰的产品创新课</a></li></ul></li><li>杂谈<ul><li><a href="/blog-test/b测试从0到1">b测试从0到1</a></li><li><a href="/blog-test/tob市场品牌实战课">tob市场品牌实战课</a></li><li><a href="/blog-test/从0开始做增长">从0开始做增长</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-test/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-test/性能测试实战30讲/01.开篇词">01.开篇词</a><ul><li><a href="/blog-test/性能测试实战30讲/01.开篇词/01"><span>开篇词丨“老板，之前咱TPS是100，我优化完是10000”</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇">02.第一模块性能测试基础篇</a><ul><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/01"><span>01丨性能综述：性能测试的概念到底是什么？</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/02"><span>02丨性能综述：TPS和响应时间之间是什么关系？</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/03"><span>03丨性能综述：怎么理解TPS、QPS、RT、吞吐量这些性能指标？</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/04"><span>04丨JMeter和LoadRunner：要知道工具仅仅只是工具</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/05"><span>05丨指标关系：你知道并发用户数应该怎么算吗？</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/06"><span>06丨倾囊相授：我毕生所学的性能分析思路都在这里了</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇">03.第二模块性能测试工具及性能场景篇</a><ul><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/01"><span>07丨性能测试工具：如何录制脚本？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/02"><span>08丨案例： 手把手教你编写最简单的性能脚本</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/03"><span>09丨关联和断言：一动一静，核心都是在取数据</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/04"><span>10丨案例：在JMeter中如何设置参数化数据？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/05"><span>11丨性能脚本：用案例和图示帮你理解HTTP协议</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/06"><span>12丨性能场景：做参数化之前，我们需要考虑什么？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/07"><span>13丨性能测试场景：如何进行场景设计？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/08"><span>14丨性能测试场景：如何理解业务模型？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/09"><span>15丨性能测试场景：如何进行监控设计？</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/04.春节策划">04.春节策划</a><ul><li><a href="/blog-test/性能测试实战30讲/04.春节策划/01"><span>春节策划丨性能评估和性能分析试题，等你挑战！</span></a></li><li><a href="/blog-test/性能测试实战30讲/04.春节策划/02"><span>春节策划丨快来挑战一下自己的分析逻辑吧！</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇">05.第三模块性能监控分析工具篇</a><ul><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/01"><span>16丨案例：性能监控工具之Grafana+Prometheus+Exporters</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/02"><span>17丨CentOS：操作系统级监控及常用计数器解析（上）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/03"><span>18丨CentOS：操作系统级监控及常用计数器解析（下）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/04"><span>19丨Java &amp; C ++：代码级监控及常用计数器解析（上）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05"><span>20丨Java &amp; C ++：代码级监控及常用计数器解析（下）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/06"><span>21丨Tomcat：中间件监控及常用计数器解析</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/07"><span>22丨MySQL：数据库级监控及常用计数器解析（上）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/08"><span>23丨MySQL：数据库级监控及常用计数器解析（下）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/09"><span>24丨Kafka：性能监控工具之队列级监控及常用计数器解析</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/10"><span>25丨SkyWalking：性能监控工具之链路级监控及常用计数器解析</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇">06.第四模块性能测试分析实战篇</a><ul><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/01"><span>26丨案例：手把手带你理解TPS趋势分析</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/02"><span>27丨案例：带宽消耗以及Swap（上）</span></a></li><li><a aria-current="page" class="active" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03"><span>28丨案例：带宽消耗以及Swap（下）</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/04"><span>29丨案例：如何应对因网络参数导致的TPS呈锯齿状？</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/05"><span>30丨案例：为什么参数化数据会导致TPS突然下降？</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/06"><span>31丨案例：当磁盘参数导致I/O高的时候，应该怎么办？</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/07"><span>32丨当Postgres磁盘读引起I/O高的时候，应该怎么办？</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/07.结束语">07.结束语</a><ul><li><a href="/blog-test/性能测试实战30讲/07.结束语/01"><span>结束语丨见过林林总总的乱象，才知未来的无限可能</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/08.结课测试">08.结课测试</a><ul><li><a href="/blog-test/性能测试实战30讲/08.结课测试/01"><span>期末测试题丨快来测试一下你对性能掌握到何种程度了吧！</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/summary">性能测试实战30讲</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="分析的第二阶段" data-depth="2"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#分析的第二阶段"><span>分析的第二阶段</span></a></li><li title="Swap的原理和对TPS的影响" data-depth="3"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#swap的原理和对tps的影响"><span>Swap的原理和对TPS的影响</span></a></li><li title="瓶颈分析定位" data-depth="3"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#瓶颈分析定位"><span>瓶颈分析定位</span></a></li><li title="优化结果" data-depth="3"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#优化结果"><span>优化结果</span></a></li><li title="后续性能工作建议" data-depth="3"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#后续性能工作建议"><span>后续性能工作建议</span></a></li><li title="分析的第三阶段" data-depth="2"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#分析的第三阶段"><span>分析的第三阶段</span></a></li><li title="瓶颈分析定位" data-depth="3"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#瓶颈分析定位-1"><span>瓶颈分析定位</span></a></li><li title="优化结果" data-depth="3"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#优化结果-1"><span>优化结果</span></a></li><li title="后续性能工作建议" data-depth="3"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#后续性能工作建议-1"><span>后续性能工作建议</span></a></li><li title="总结" data-depth="2"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#总结"><span>总结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="28丨案例带宽消耗以及swap下"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#28丨案例带宽消耗以及swap下"><span class="icon icon-link"></span></a>28丨案例：带宽消耗以及Swap（下）</h1><p>上一篇文章我主要分析了带宽消耗，今天，我们来看一下分析的第二和第三阶段，也就是Swap分析和数据库分析。</p><h2 id="分析的第二阶段"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#分析的第二阶段"><span class="icon icon-link"></span></a>分析的第二阶段</h2><h3 id="swap的原理和对tps的影响"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#swap的原理和对tps的影响"><span class="icon icon-link"></span></a>Swap的原理和对TPS的影响</h3><p>前面有一个扣，是说swap多的问题。要理解swap为什么是黄的，得先知道什么是swap。我先画个简易的示意图。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage1fe51fd061cbf986f9cea3509bd4699ddbe5.f1909fa6.jpg" alt=""/></p><p>这里先解释一下，对于一个Linux系统来说，如果配置并开启了swap分区，那么默认的swappiness参数是60。</p><p>swappiness是在内存reclaim的时候生效的，而reclaim方式同时有两个动作：1. 将file相关内存进行回收；2. 将anon内存交换到swap分区。</p><p>所以swapiness值越大，swap分区就用得越多。</p><p>对我们现在分析的这个系统来说，来看一下：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagee27fe29ec84d980fb9e667e41010b209427f.c820c5f2.png" alt=""/></p><p>我们看到这里配置了一个内存为8G左右，已经使用了7G多了，swappiness配置为30%。</p><p>通过free看到现在只有145M的物理内存剩余，可用内存也只有254M了。<br/>所以上面图中的swap飘黄也是很合理的喽！</p><p>下面我们就针对应用服务器的swap来看是不是可优化。</p><p>所有人都知道，当swap被用的时候，性能肯定会下降，所以在我的测试过程中，一般我都建议把swap直接关掉测试性能，有人说这样有什么问题？</p><p>那就是没有swap，让不常用的对象直接占用物理内存，如果物理内存不够用，就把对象删了，后面再创建，这时会增加的是major fault，那就增加好了，反正是要性能差的。</p><p>说得如此硬气，那在生产中怎么办呢？开还是关？有人觉得关了心里有安稳，有人觉得开着心里会安稳。而一个系统、一个容器、一个节点，如果容量控制的非常好的情况下，我建议关掉。开着它，也只是心里上的安慰，不会有TPS处理能力上的提升。</p><h3 id="瓶颈分析定位"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#瓶颈分析定位"><span class="icon icon-link"></span></a>瓶颈分析定位</h3><p>既然知道了上面的大概原理。对一个运行Tomcat应用的服务器来说，那肯定是要先检查一下JVM设置为多大。先执行ps命令，看一下Java进程吧。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage8dba8d6525787d1234c738f629389b5da5ba.4b6de2ff.png" alt=""/></p><p>关键参数如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">JAVA_OPTS=&quot;$JAVA_OPTS -server -Xms2048M -Xmx8192m -XX:PermSize=256M -XX:MaxNewSize=2790m -XX:MaxPermSize=512m -XX:SurvivorRatio=8&quot;</span></div></pre></div><p>JVM是1.8.0_65。</p><p>这个参数配置有很大的问题。物理内存只有8个G，一个JVM heap就配置了8G，这让其他的东西怎么玩得起来？并且JDK是1.8了，配置permsize是又为啥呢？</p><p>虽说有多个地方配置不合理，但是我们也得要知道一下应该配置多少是合理的吧。</p><p>看参数的时候，JMX也配置上了，那就用工具来看吧。</p><p>首先来看一下系统资源。先看一下系统资源在压力下的表现：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimageef66ef8154abc5d60e04752a5d9ea29d4966.d2a1eb96.png" alt=""/></p><ol><li>队列已经出现，CS 2万多，in 2万多，说多不多。我们可以先放着。</li><li>I/O没什么压力，swap也一直有值，我们要解决的就是它。</li><li>us：sy接近2：1，这个是不良信号，记在心里，后面再说。</li></ol><p>其次再看下JVM的情况：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimaged8f1d84de678e28c64b46b1b69b8b30b77f1.08f6056b.png" alt=""/></p><p>CPU使用在应用上的时间达到60%，GC上没耗什么时间，并且从堆的回收能力上来看，比较正常，只是只用到了3G左右，这里有必要给8G吗？</p><p>线程活动的达到347，看起来还是在增加的，这里也可能是个问题点，只是现在我们不用关心，它还没跳出来。</p><p>从这个JVM状态上来看，它完全用不到8G。在这种状态下，还有另一个Tomat，并且另一个Tomcat中也没有配置-Xmx -Xms参数，当没有配置时，默认-Xmx是物理内存的1/4。再加上thread用的，所以swap飘黄也是吻合的。</p><h3 id="优化结果"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#优化结果"><span class="icon icon-link"></span></a>优化结果</h3><p>首先，我们把JVM配置成最简，JVM设置为4G。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">JAVA_OPTS=&quot;$JAVA_OPTS -server -Xms4096M -Xmx4096m&quot;</span></div></pre></div><p>perm区在1.8里都没有了，这几个参数也没啥用。在我的习惯中，MaxNewSize也是先看要用到多少，再决定配置不配置。有些应用自己不熟悉，也无法直接给出配置，只有测试之后再配置。</p><p>各部分配置为多大，都没有定数，要通过测试看需要多少。</p><p>而我们现在最重要的是先把性能调整上去，再考虑这些细节内容。这样修改JVM就是为了把物理内存使用率低下来，先不修改swapiness的比例是为了看下结果，如果用不到swap就不再调了，如果还是用了swap，再来调它。</p><p>当我们把JVM修改了之后，再执行起来场景。看到内容如下：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage404440116bf5ff367647f3f41143fd47fd44.19a5c071.png" alt=""/></p><p>CPU使用率相对前面没有什么变化，但是堆4G只用到了1.5G，可见这个堆连4G都用不到。当然我们还是要分析下其他的内容。</p><p>还记得我们要解决的是什么问题吧？swap飘黄了！</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimaged81fd8ec1c105537e046a98440790462f91f.2847d628.png" alt=""/></p><p>从这张图可以看到Swapping不报警了！CPU占用70%左右。说明现在available的内存是充足的。</p><p>这时我们再看一下系统资源，首先是应用服务器系统资源。</p><p>应用服务器系统资源vmstat如下：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage10671002a324619b0fe3ba5d6a0d7af53e67.9d05e1b0.png" alt=""/></p><p>应用服务器系统资源top：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage614161b13011e46b803fef61dde5030e4541.d1ee6ead.png" alt=""/></p><p>应用服务器系统资源iftop:</p><p><img src="data:image/png;base64,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" alt=""/></p><p>上图中可以看到，对比之前的资源，swap基本上没有了，CPU使用率多起来了。但是队列依旧长，sy CPU消耗还是有点多了。</p><p>应用服务器的si已经到了13.1%了，这个值要关注下，暂时还不能说是问题，但是接着增加下去，肯定会是问题。</p><p>网络已经超过70Mbps了，峰值上到87Mbps，这是一个好事，它说明现在处理的业务量确定多了。</p><p>接下来是数据库服务器系统资源：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage8527851e322ad9561715a30fc1ce79052027.0bb45812.png" alt=""/></p><p>你可以看到数据库CPU都用到这么高了？</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagef32bf36982dff7c811cbe9d5ca8d9cf0862b.92a4fe14.png" alt=""/></p><p>TPS能到259.2了，较之前的221.5没有提升多少。但是我们解决了swap的问题，还是有了一点点的提升。</p><p>那下一个瓶颈在哪里呢？通过上面的数据库资源来看，数据库早就已经被用到了100%的CPU，队列也嗖嗖地涨到了好几十，高的都超过100了。</p><p>可见我们在处理应用服务器的时候，数据库这边已经早就吃不消了。那下面，我们就先把应用服务器的优化部分放一下，再去分析下一个短板：数据库。</p><h3 id="后续性能工作建议"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#后续性能工作建议"><span class="icon icon-link"></span></a>后续性能工作建议</h3><p>但是这里并不是说应用服务器的优化工作就完成了，还有一些部分需要做的。</p><ol><li>优化JVM配置参数，至于应该配置成什么值，还需要再测试，可能会有人说，这个测试人员怎么知道呢？请你相信，如果这个值性能测试人员都测试不出来的话，一般的架构师也不可能知道该设置为多少。</li><li>通过监控分析确定swapiness的值。</li><li>网络带宽又快到占满了，如果TPS再提高，网络肯定又支撑不了。</li></ol><p>这些扣也都放在这里。因为我们主要是找到系统的短板，并一一解决，才能使整体的TPS增加，虽说现在应用服务器上还有优化的空间，但是现在它不是最短的板。</p><p>我们在不忘记应用服务器这些问题的同时，再将目光转向数据库。</p><h2 id="分析的第三阶段"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#分析的第三阶段"><span class="icon icon-link"></span></a>分析的第三阶段</h2><h3 id="瓶颈分析定位-1"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#瓶颈分析定位-1"><span class="icon icon-link"></span></a>瓶颈分析定位</h3><p>先来看看数据库的系统资源。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>我在很多场合都在强调一个词：证据链。所以基本上分析也会是从OS层面开始。</p><p>但是证据链这个词说起来容易理解，实际上要想真的有链起来的能力，必须具有基础知识，像分析数据库就更明显。因为当我们不了解系统架构时，想说明一个事情就非常困难。</p><p>像上面的这个top，显然us CPU使用率非常地高，idle几乎没有了，只有一个si占了5.7%，这个si并不算高，我们在上一阶段看到的应用服务器的si都已经达到了13%了。</p><p>我们说si的高或者低，倒不是关键，关键的是它有没有成为我们的瓶颈点。在这个系统中，us cpu才是我们要关注的重点，因为它实在是太高了。</p><p>对于一个数据库来说，要干的事情就是执行SQL。当分析多了数据库之后，基本上也形成了套路。不管怎么样，还是先看一下基本的监控信息，以下截取一些Spotlight on MySQL的有用的图，如果你没有这个工具，用其他的监控工具也是一样的。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagebd09bd2d900a6d737649dcccf53c81584409.806e49a7.png" alt=""/></p><p>从上面的图可以看到，CPU使用率99%，Query Cache 是OFF的。记下这个位置！</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagec21dc2c538d0c263c6e87d77b3b78402151d.e93c0bab.png" alt=""/></p><p>从上图看到，负载队列非常长，但Disk I/O没多少，说明队列和I/O无关，只是CPU的队列，非常好！</p><p>Network也不算大，进出每秒5000多个包，我们再来看一下网络用到多少了？</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYYAAAA+CAMAAAAYsEx7AAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAADPUExURWlpaQAAAHfDwsDAwAcAUJNJAAIALSFLb4KkwzOKqaqKPjAAAKqJZq9qAsWlhHUkAAJpq57Cwb/Coo5tEwAjcVmmxL/DglQAADeHxgBsjaSnhpBnisWmYcqGZMqIOSRHjqajw1EqAHTGhR1OTSotAABIjmWIqJNIG3JLISwnT5NGR4GnpsajpCsrK5zFhJ3DowApT21qjKSoZG5mqXNGbVeop6WlpVMdcC4hcFUAKgAtLImJiU1Jb3XFpa9pQkVoqo5sRTEALABMcICoh////8ld79oAAAABYktHRET5tJjBAAAAB3RJTUUH5wkXCBULqT/i6QAAAAFvck5UAc+id5oAAAXBSURBVHja7ZqLdps4EIYjMDQ2i7kUJ7Tr4job4u42TVJv7Hazl+627/9Oq5mRuPmCEqdY9Og/p2lkjBj0oxnxRScnzOj4OjE26CBjgxYyNmghY4MWMjZoIWODFkIbLNvouDKzQQsZG7SQsUELGRu0kLFBCxkbtBDa0Fw+HTsoXTSwnI7667cN7otTvDF3aNsjr/I5b//kPbXXQso2DODNy6frjoPy8zCy45cq/aEN4sRk5E5s++w87XAgD9Kr1z9HeGPh1HMnfuX23/B2xn+ZveXjMsdRGp8/un91Gy6oc4hjmJWf/3LJksgZWFOP95UpzAYnh2ngD6w4CPlscCdnj4/6kAGN4PHFMMOM5dOreDGMg/Y46MbwZ15+052Idhq/Y+zXSzhes2mjl99O6SnmcYzn/IF8D+5Rv0OYZi1xFDZk9K8ifl0YVJZfj3h/i6vabNlhQxzkL2d29zaEMFwfWGGDvQjjIPVVbUhu+JeS26D2KW8nNFewfbfnyR5Y47mb8kc2PJvDE83u5mgbP88d+jSY+22w7OsF/H86/rj0GoecwcXvPhvej8rrtNjAM1ISdV8b5JNazgaP/0z99jPJBpwI1RmfQnKwnVCMHSSleNHSC7cN40BPoQ9IIovVgqlpBpa7q3WjJqGbF59uPi0/j4rrtNoAObZ7G+QIPtWG5mxg7pUd398GYEPI7w2+9dnK9vfCz8cawlMCnG/bYMN6qlzouW0Q8t2keoq78iFl/TFZ+4m6DWfnQ57Jjjsb0sfb0KwNKN7GO4assO14sxd+XMbBy7tHs8FJlX1Is81hpg555YBgRmx3HHUbnBDKwzFqA5/7D7jaCaOqDWq1oVgpDSz6+oNHtSClOkuzbJ8NGa2ssEY98KUCPNU4rCKVt8Th4oqIf+uNh9eRcdDJVMDRBnGd/Tb4M5wR4XFWSry25ZHth+o2hCKRFu8N8vZnkagFs7fX6zUlm60rFGnDnxHldIjj9RziWP4VZbTCmravlBKL3g8GK1xhyTgoyfmlDX/fR9vfZ/r9+vZMeu635cfL2MCMDZpIExuMulELzOitGuisRHp3p3XW950lEWMzHsbkizyqxQas6Dz8PA50mKHqInRWtiXSS6IFwJFD0Z6qCsTYjIevsGyHqaI9Yi4+rq3pjaPrBevTVUV2JdITa3NFtHe4ygGuXyf8ZwI2qKE9CjPD18cvI+qsLzZUn7CSDf2LxFQV7T1nFLUnPln+BzYooj04dQYJieZPn1R/+ATSw9v9wt9DFdHe4SoGvxaPuwpctEEN7UGY8PIHSTUO2i+qjxCdVZqE9ABG8FdWZbR3uKQN9XhCn5ENamiPH04ihFDWIuxLNsK73pLwJaLjNqiivcMlbKjHA7BawAwltAeHMY+mPtWIvtQGmWebSA+WfPDnG0W0d7iEDc14mJgNamiPXLp1whE2FMimHhLobAvSgz9mwidqaO9QScS4EU/Thv1oz+jYMjZoIWODFjI2dKgfFe1JpPY12ty19x1L8qYESmzsFqSSnVXae22g9S0v9TMkhG7RFn8C1JX2FUjt4ZKYmFSxe64btFegxGK3YCl3pbxrj9H2Dr7cfidvR8Cx/Po2qIMrvRayO5Ca3D3XFdoTo1WgxYpyXxntiY7ISOpGdJw68EsfbHhxUwlM7J7rCu1JlLgFVgy+nSujPUbDLvZeYTdkQ7L0YCuWrkmptCGtozuxe64rtCdRokSLlUOhw5TRHttlA7Ipvwc2sHptELvnukJ7EiVKtFgeSWBHqyraYzuSEtXqqdcHG6o7qYutxB2hPYkSsVG7zhA3FSqiPbajROfEmBztawMivZLlFLvnukJ7EiVKtCiZEk4GZbTHZBKaFX/SxnZK2DAr17962VDs2nvFc391157cPdcR2itQokSLMg6aoQbt9UXGBi1kbNBCxgYtZGzQQsYGLWRs0ELGBi1kbNBCxgYtZGzQQsYGLfQ/Gfrig2U3BQsAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjMtMDktMjNUMDg6MjE6MTErMDA6MDCRI3jiAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIzLTA5LTIzVDA4OjIxOjExKzAwOjAw4H7AXgAAACh0RVh0ZGF0ZTp0aW1lc3RhbXAAMjAyMy0wOS0yM1QwODoyMToxMSswMDowMLdr4YEAAAAASUVORK5CYII=" alt=""/></p><p>峰值也才70Mbps左右，即使是100Mbps带宽，现在仍然认为有余量（注意！我这里说有余量是因为我同时也检查了网络队列，并没有阻塞，并不是只看了这个值就武断地做了判断）。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagecf63cf347ab9406ffcb3a281f1ef4a646263.6259cadd.png" alt=""/></p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage23ec23e8f83c88e76c1c44badabaea44deec.eba8a0fb.png" alt=""/></p><p>通过上面的图可以看到，每秒执行2500-3000的SQL，Sorts per second达到800-1000，Sort rows per second达到8000-10000。</p><p>session用得倒是也不多，但Miss Rates在压力过程中Query Cache都是在100%，并且从最上面的summary中可以看到Query Cache也是OFF的。</p><p>为什么没有在看到Query Cache是OFF的时候就敲黑板呢，这是因为在一些应用中，如果不是查询多的话，这个值OFF也不能说有问题，但是在这个应用中几乎所有的语句都是select，那这个Query Cache再不打开就说不过去了呀。这里先记录下这个问题，待会我们的优化动作就是打开Query Cache。</p><p>不管怎么说，对一个数据库来说，主要是执行SQL嘛，而对MySQL来说，不看slow log，还能看什么呢。</p><p>通过整理slow log，看到如下内容：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"># Overall: 280 total, 1 unique, 0.59 QPS, 9.53x concurrency ______________</span></div><div class="token-line"><span class="token plain">    # Time range: 2019-09-26T13:44:08 to 2019-09-26T13:52:06</span></div><div class="token-line"><span class="token plain">    # Attribute          total     min     max     avg     95%  stddev  median</span></div><div class="token-line"><span class="token plain">    # ============     ======= ======= ======= ======= ======= ======= =======</span></div><div class="token-line"><span class="token plain">    # Exec time          4555s     12s     19s     16s     18s      2s     16s</span></div><div class="token-line"><span class="token plain">    # Lock time           52ms   130us   662us   185us   273us    53us   167us</span></div><div class="token-line"><span class="token plain">    # Rows sent              0       0       0       0       0       0       0</span></div><div class="token-line"><span class="token plain">    # Rows examine      30.81M 112.69k 112.69k 112.69k 112.69k       0 112.69k</span></div><div class="token-line"><span class="token plain">    # Query size       186.48k     682     682     682     682       0     682</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Profile</span></div><div class="token-line"><span class="token plain">    # Rank Query ID           Response time    Calls R/Call  V/M   Item</span></div><div class="token-line"><span class="token plain">    # ==== ================== ================ ===== ======= ===== ===========</span></div><div class="token-line"><span class="token plain">    #    1 0xBED932B8C940697E 4555.0867 100.0%   280 16.2682  0.16 SELECT test2</span></div></pre></div><p>什么情况？只有1 unique？0.59TPS？我前面的TPS可是有259.2，这结果一看就感觉不对。</p><p>查看一下long_query_time，配置成了10s，怪不得看不到慢SQL。</p><p>改long_query_time为1s，再跑一遍。看到如下结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"># Overall: 620.47k total, 30 unique, 259.39 QPS, 16.76x concurrency ______</span></div><div class="token-line"><span class="token plain">    # Time range: 2019-09-26T13:44:08 to 2019-09-26T14:24:00</span></div><div class="token-line"><span class="token plain">    # Attribute          total     min     max     avg     95%  stddev  median</span></div><div class="token-line"><span class="token plain">    # ============     ======= ======= ======= ======= ======= ======= =======</span></div><div class="token-line"><span class="token plain">    # Exec time         40082s    88us     23s    65ms   323ms   649ms   332us</span></div><div class="token-line"><span class="token plain">    # Lock time            61s    30us   363ms    97us   152us     1ms    69us</span></div><div class="token-line"><span class="token plain">    # Rows sent          1.92M       0     633    3.25   21.45    7.43    0.99</span></div><div class="token-line"><span class="token plain">    # Rows examine     987.99M       0 112.69k   1.63k  10.29k   5.49k  420.77</span></div><div class="token-line"><span class="token plain">    # Query size       240.33M      89   1.52k  406.15  833.10  258.19  246.02</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    # Profile</span></div><div class="token-line"><span class="token plain">    # Rank Query ID           Response time    Calls  R/Call  V/M   Item</span></div><div class="token-line"><span class="token plain">    # ==== ================== ================ ====== ======= ===== ==========</span></div><div class="token-line"><span class="token plain">    #    1 0x160FA75270C56FB8 22892.5442 57.1%  65352  0.3503  0.16 SELECT test1</span></div><div class="token-line"><span class="token plain">    #    2 0xBED932B8C940697E 15914.4501 39.7%    986 16.1404  0.44 SELECT test2</span></div><div class="token-line"><span class="token plain">    #    4 0xF0AE7AFA7851C7E8   245.0176  0.6%    175  1.4001  0.11 SELECT test3</span></div><div class="token-line"><span class="token plain">    #    5 0xFB5A64603A53BFCE    97.2016  0.2%     77  1.2624  0.04 SELECT test4</span></div><div class="token-line"><span class="token plain">    #   14 0x1E088E88CDC208BE     8.7701  0.0%     14  0.6264  0.23 SELECT test5</span></div></pre></div><p>嗯，这看着顺眼多了。前两个SQL占了所有执行时间的96.8%！第一个SQL平均执行时间350ms，方差16%。而第二个语句更夸张，平均执行时间16s，方差44%。这得收拾！</p><p>但是要不要优化这样的SQL，我们就需要根据SQL的分析和业务的分析来判断了。这里我先把执行计划列出来看看。</p><p>SQL1的执行计划：</p><p><img src="data:image/png;base64,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" alt=""/></p><ol><li>没有分区。</li><li>不包含子查询或者union操作。</li><li>全表扫描。</li><li>第一个表所查有70行，第二个表所查有631行，此值仅做为参考，并不精准。</li><li>第一个表返回结果只占了读取行数的1.43%（优化点），第二个表返回结果只占了0.16%（优化点）。</li><li>在第一个表中，Extra有一个值，using where。</li><li>在第二个表中，Extra有一个值，Range checked for each record (index map: 0x1) 。</li></ol><p>SQL2的执行计划：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimageecc4ecbcccf81290dc50cb6192782500cfc4.856f413f.png" alt=""/></p><ol><li>没有分区。</li><li>不包含子查询或者union操作。</li><li>非唯一索引查找，也列出了具体的索引。</li><li>第一个表索引列上有102570行，第二个表索引列上有118行。此值仅做为参考，并不精准。</li><li>第一个表返回结果只占了读取行数的3.33%（优化点），第二个表返回结果占了100%。</li><li>在第一个表中，Extra有三个值，using index condition; using where; using filesort。</li><li>在第二个表中，Extra有一个值，using where。</li></ol><p>这里我要敲黑板了！！！你是不是不记得Extra这些值的含义了？是不是要祭出你的搜索引擎，要开始查了！</p><p>我们这里再来回顾一遍。</p><p>using where：对结果用where子句中的条件过滤。</p><p>Range checked for each record (index map: 0x1)：MySQL没有找到可以使用的索引，如果前面的表的列值已知，可能会部分使用索引。</p><p>using index condition：先条件过滤索引，找到所有符合索引条件的数据行，再用where子句中的条件做过滤。</p><p>using filesort：Query中有Order By操作，又无法用索引完成排序，MySQL不得不选择相应的排序算法来实现。是不是对应上了前面的sorts per second？</p><p>知道了这些基础知识之后，下面再来看一下，两句语句很显然都有优化的空间，尽量使用filtered的比例能大一些，至于能不能用到索引，那就看业务的需要了，如果确实是要查很大的索引，表扫还能快点。所以这两个语句，要丢给开发做业务分析了。</p><h3 id="优化结果-1"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#优化结果-1"><span class="icon icon-link"></span></a>优化结果</h3><p>对数据库，我们有两个优化的方向还记得吧，第一个是SQL语句，第二个是 Query Cache。</p><p>我们先做第2个，将Query Cache开启，看一下效果如何。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; show variables like &#x27;query_cache%&#x27;;</span></div></pre></div><p>查看结果如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">query_cache_type  ON</span></div><div class="token-line"><span class="token plain">    query_cache_size  1048576</span></div></pre></div><p>再执行起来场景，看系统资源：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagea5b7a5fb75d8b6af58760d2eb7f9976df4b7.517e5b74.png" alt=""/></p><p>效果还不错哦，us CPU降到了50%以下。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>网络峰值时能达到90Mbps了，又快把带宽占完了。</p><p>查看网络队列：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage298c297e4d951b9b1aa3e439137aab87598c.552ad708.png" alt=""/></p><p>再检查下队列，这时看到已经有接收队列了。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage4a094a813c91a6a79d3ff359666c581f3c09.6df5ea93.png" alt=""/></p><p>从TPS上来看，现在能到300多一点，同时网络接收发送加在一起8M左右。</p><h3 id="后续性能工作建议-1"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#后续性能工作建议-1"><span class="icon icon-link"></span></a>后续性能工作建议</h3><p>接下来数据库的优化方向就是优化SQL。</p><p>当然还有别的优化建议，我们将在后面再说。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#总结"><span class="icon icon-link"></span></a>总结</h2><p>这个案例从一个概括的描述开始，到各阶段的分析定位，是一个非常完整的过程。从一个项目的角度上来说，现在是不是性能已经达标，要有两方面的判断。</p><ol><li>技术方面来说，显然这系统还有很多优化的空间，我们在文中也留了不少的扣。</li><li>业务方面来说，系统是否可以上线，就取决于业务指标了。</li></ol><p>但是这个性能是不是已经做得完整了呢？显然还没有。现在只是调了一个节点而已。因为这是在测试环境中做的，硬件环境显得非常简单。线上部署结构也会包括分布式多节点集群等。所以从一个性能项目的角度来说，还远远没有结束。我想如果把这个项目完整地写下来，一本书的容量应该不为过。</p><p>从技术细节上来说，通过几个阶段的具体操作，可以让你有一个性能分析定位的宏观感受，这也是这两篇内容的初衷。性能优化是无止境的，我们要做的是以最少的时间和金钱成本，达到最大的优化效果。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>这一篇文章延续上一篇的分析思路，你能讲一下Swap的原理和逻辑，以及分析思路吗？另外，慢SQL如何定位出来呢？</p><p>欢迎你在评论区写下你的思考，也欢迎把这篇文章分享给你的朋友或者同事，一起交流一下。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/性能测试实战30讲/06.第四模块性能测试分析实战篇/03.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 22:08:02</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-test/umi.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-test/umi.css" />
    <script>
      window.routerBase = "/blog-test";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>
      20丨Java &amp; C ++：代码级监控及常用计数器解析（下） - 大师兄
    </title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/性能测试实战30讲/05.第三模块性能监控分析工具篇/05" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>前端开发<ul><li><a href="/blog-test/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li></ul></span><span>软件测试<ul><li><a href="/blog-test/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a aria-current="page" class="active" href="/blog-test/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-test/接口测试入门课">接口测试入门课</a></li><li><a href="/blog-test/程序员的测试课">程序员的测试课</a></li><li><a href="/blog-test/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog-test/软件测试52讲">软件测试52讲</a></li></ul></span><span>产品与用户体验<ul><li><a href="/blog-test/成为ai产品经理">成为ai产品经理</a></li><li><a href="/blog-test/硅谷产品实战36讲">硅谷产品实战36讲</a></li><li><a href="/blog-test/苏杰的产品创新课">苏杰的产品创新课</a></li></ul></span><span>杂谈<ul><li><a href="/blog-test/b测试从0到1">b测试从0到1</a></li><li><a href="/blog-test/tob市场品牌实战课">tob市场品牌实战课</a></li><li><a href="/blog-test/从0开始做增长">从0开始做增长</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>前端开发<ul><li><a href="/blog-test/新时代产品经理进阶之路">新时代产品经理进阶之路</a></li></ul></li><li>软件测试<ul><li><a href="/blog-test/全链路压测实战30讲">全链路压测实战30讲</a></li><li><a aria-current="page" class="active" href="/blog-test/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-test/接口测试入门课">接口测试入门课</a></li><li><a href="/blog-test/程序员的测试课">程序员的测试课</a></li><li><a href="/blog-test/自动化测试高手课">自动化测试高手课</a></li><li><a href="/blog-test/软件测试52讲">软件测试52讲</a></li></ul></li><li>产品与用户体验<ul><li><a href="/blog-test/成为ai产品经理">成为ai产品经理</a></li><li><a href="/blog-test/硅谷产品实战36讲">硅谷产品实战36讲</a></li><li><a href="/blog-test/苏杰的产品创新课">苏杰的产品创新课</a></li></ul></li><li>杂谈<ul><li><a href="/blog-test/b测试从0到1">b测试从0到1</a></li><li><a href="/blog-test/tob市场品牌实战课">tob市场品牌实战课</a></li><li><a href="/blog-test/从0开始做增长">从0开始做增长</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-test/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-test/性能测试实战30讲/01.开篇词">01.开篇词</a><ul><li><a href="/blog-test/性能测试实战30讲/01.开篇词/01"><span>开篇词丨“老板，之前咱TPS是100，我优化完是10000”</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇">02.第一模块性能测试基础篇</a><ul><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/01"><span>01丨性能综述：性能测试的概念到底是什么？</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/02"><span>02丨性能综述：TPS和响应时间之间是什么关系？</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/03"><span>03丨性能综述：怎么理解TPS、QPS、RT、吞吐量这些性能指标？</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/04"><span>04丨JMeter和LoadRunner：要知道工具仅仅只是工具</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/05"><span>05丨指标关系：你知道并发用户数应该怎么算吗？</span></a></li><li><a href="/blog-test/性能测试实战30讲/02.第一模块性能测试基础篇/06"><span>06丨倾囊相授：我毕生所学的性能分析思路都在这里了</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇">03.第二模块性能测试工具及性能场景篇</a><ul><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/01"><span>07丨性能测试工具：如何录制脚本？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/02"><span>08丨案例： 手把手教你编写最简单的性能脚本</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/03"><span>09丨关联和断言：一动一静，核心都是在取数据</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/04"><span>10丨案例：在JMeter中如何设置参数化数据？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/05"><span>11丨性能脚本：用案例和图示帮你理解HTTP协议</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/06"><span>12丨性能场景：做参数化之前，我们需要考虑什么？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/07"><span>13丨性能测试场景：如何进行场景设计？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/08"><span>14丨性能测试场景：如何理解业务模型？</span></a></li><li><a href="/blog-test/性能测试实战30讲/03.第二模块性能测试工具及性能场景篇/09"><span>15丨性能测试场景：如何进行监控设计？</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/04.春节策划">04.春节策划</a><ul><li><a href="/blog-test/性能测试实战30讲/04.春节策划/01"><span>春节策划丨性能评估和性能分析试题，等你挑战！</span></a></li><li><a href="/blog-test/性能测试实战30讲/04.春节策划/02"><span>春节策划丨快来挑战一下自己的分析逻辑吧！</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇">05.第三模块性能监控分析工具篇</a><ul><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/01"><span>16丨案例：性能监控工具之Grafana+Prometheus+Exporters</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/02"><span>17丨CentOS：操作系统级监控及常用计数器解析（上）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/03"><span>18丨CentOS：操作系统级监控及常用计数器解析（下）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/04"><span>19丨Java &amp; C ++：代码级监控及常用计数器解析（上）</span></a></li><li><a aria-current="page" class="active" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05"><span>20丨Java &amp; C ++：代码级监控及常用计数器解析（下）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/06"><span>21丨Tomcat：中间件监控及常用计数器解析</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/07"><span>22丨MySQL：数据库级监控及常用计数器解析（上）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/08"><span>23丨MySQL：数据库级监控及常用计数器解析（下）</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/09"><span>24丨Kafka：性能监控工具之队列级监控及常用计数器解析</span></a></li><li><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/10"><span>25丨SkyWalking：性能监控工具之链路级监控及常用计数器解析</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇">06.第四模块性能测试分析实战篇</a><ul><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/01"><span>26丨案例：手把手带你理解TPS趋势分析</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/02"><span>27丨案例：带宽消耗以及Swap（上）</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/03"><span>28丨案例：带宽消耗以及Swap（下）</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/04"><span>29丨案例：如何应对因网络参数导致的TPS呈锯齿状？</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/05"><span>30丨案例：为什么参数化数据会导致TPS突然下降？</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/06"><span>31丨案例：当磁盘参数导致I/O高的时候，应该怎么办？</span></a></li><li><a href="/blog-test/性能测试实战30讲/06.第四模块性能测试分析实战篇/07"><span>32丨当Postgres磁盘读引起I/O高的时候，应该怎么办？</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/07.结束语">07.结束语</a><ul><li><a href="/blog-test/性能测试实战30讲/07.结束语/01"><span>结束语丨见过林林总总的乱象，才知未来的无限可能</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/08.结课测试">08.结课测试</a><ul><li><a href="/blog-test/性能测试实战30讲/08.结课测试/01"><span>期末测试题丨快来测试一下你对性能掌握到何种程度了吧！</span></a></li></ul></li><li><a href="/blog-test/性能测试实战30讲/summary">性能测试实战30讲</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="Java类应用查找对象内存消耗" data-depth="2"><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#java类应用查找对象内存消耗"><span>Java类应用查找对象内存消耗</span></a></li><li title="内存趋势判断" data-depth="3"><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#内存趋势判断"><span>内存趋势判断</span></a></li><li title="查找增加的内存" data-depth="3"><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#查找增加的内存"><span>查找增加的内存</span></a></li><li title="C/C++类应用查找方法执行时间" data-depth="2"><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#cc类应用查找方法执行时间"><span>C/C++类应用查找方法执行时间</span></a></li><li title="C/C++类应用查找对象内存消耗" data-depth="2"><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#cc类应用查找对象内存消耗"><span>C/C++类应用查找对象内存消耗</span></a></li><li title="总结" data-depth="2"><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#总结"><span>总结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="20丨java--c-代码级监控及常用计数器解析下"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#20丨java--c-代码级监控及常用计数器解析下"><span class="icon icon-link"></span></a>20丨Java &amp; C ++：代码级监控及常用计数器解析（下）</h1><p>在上一篇文章中，我们描述了在Java开发语言中如何抓取方法的执行时间，其中描述的操作也是我们在分析时经常使用的。</p><p>今天我们将接着描述如下几点内容：</p><ol><li>Java语言中如何查找有问题的内存对象。</li><li>简单介绍一下在C/C++语言中如何查找方法执行时间和对象的内存消耗。</li></ol><p>之所以要描述C/C++语言的相关内容，就是为了告诉你，几乎在任何一语言中都有相应的工具，都有办法捕获到相应的内容。</p><p>下面我们来看看如何抓取Java应用中对象占用多大内存，以及如何分辨占用是合理的和不合理的。</p><h2 id="java类应用查找对象内存消耗"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#java类应用查找对象内存消耗"><span class="icon icon-link"></span></a>Java类应用查找对象内存消耗</h2><p>对Java的内存分析通常都落在对JVM的使用上（不要认为我这句话说得片面），再具体一点，说的就是内存泄露和内存溢出。由于现在对象都是可变长的，内存溢出就不常见了；而由于底层框架的慢慢成熟，内存泄露现在也不常见了。</p><p>有人说了，那你还啰嗦个什么劲呢？别捉急呀，不常见不等于没有。只是说它不再是No.1级的问题，但是排在No.2级还是没问题的。</p><p>如果你的应用有了问题，看到了像这样的图：</p><p><img src="data:image/png;base64,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" alt=""/><br/>这是我在一个项目中遇到的问题，图片不够清晰，我们只要关注黄线的趋势就好。</p><p>之所以把它拿出来说事，是因为这个问题太极端了。上图是近20天的JVM使用率，从曲线的趋势上就可以看出来，它存在明显的内存泄露，但是又泄露得非常非常慢。这个系统要求24x365运行。</p><p>做过运维的人会知道，如此长时间的运行，运维时间长了之后，只会对这样的系统做常规的健康检查，因为前期天天关注它，又不出问题，眼睛都看瞎了，也不值得，于是后期就放松了警惕，慢慢懈怠。</p><p>而这个系统在生产上出现事故是在正常运行快到一年的时候，这个系统的业务量不大，十几个TPS的业务量级。这是一个外贸的系统，业务量虽然不大，但每个业务涉及的金额很大。其实出故障时间倒也不长，才几个小时，但是也干掉了几个总监级职位及相关人员。</p><p>如何对内存进行分析，仍然是性能测试分析的从业人员应该知道的知识点。</p><p>我们从技术的角度来说一下内存问题的排查思路。</p><p>这下我换个实例程序。我们照样用jvisualvm，记住哦，这时候Arthas之类的工具就没得玩了，因为Arthas只会操作栈，有很多在Java方面做性能分析的工具都是只分析栈的。在Java中动态操作对象，其实资源消耗非常高。打个比方，你可以想像一下，在一个课间休息的校园，像寻找一个特定的孩子有多难。</p><p>其实操作一个对象还有迹可循，但是内存中那么多对象，要想全都控制，那几乎是不理智的。所以，我们首先要看内存整体的健康状态。</p><h3 id="内存趋势判断"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#内存趋势判断"><span class="icon icon-link"></span></a>内存趋势判断</h3><p><strong>场景一：典型的正常内存的场景</strong></p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagee338e3b1d3c0eb74914f3f3e04d4483f4d38.0e3095eb.png" alt=""/></p><p>看了这个图后，要有如下几个反应：</p><ol><li>内存使用很正常，回收健康。</li><li>内存从目前的压力级别上来看，够用，无需再增加。</li><li>无内存泄露的情况，因为回收之后基本回到了同一水位上。</li><li>基本也能看得出来GC够快。为什么说基本呢？因为最好还是看一下这张图。</li></ol><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimageb84bb8f84cf6e690b84b98ded381e8e0ba4b.13696b65.png" alt=""/></p><p>从这张图可以看到，当应用在压力场景之后，GC并没有消耗过多的CPU。</p><p><strong>场景二：典型的内存分配过多的场景</strong></p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage2dd52ddbc9cf8f99e5d13c8d2b65b26dbcd5.1a21899b.png" alt=""/></p><p>从这张图我们可以看出来：</p><ol><li>内存使用很正常，回收健康。</li><li>从目前的压力级别上来看，内存不仅够用，而且过多。</li><li>无内存泄露的情况。</li></ol><p><strong>场景三：典型的内存不够用的场景</strong></p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage7f727f3c24cf57f51588fdb0657ee8983572.99fc02a9.png" alt=""/></p><p>从这张图我们可以看出来：</p><ol><li>内存使用很正常，回收健康。</li><li>从目前的压力级别上来看，<strong>内存不够用，需再增加。</strong></li><li>CPU可看可不看，因为现在看似乎没多大意义，先加了内存再说。</li><li>无内存泄露的情况，因为回收之后基本回到了同一水位上。</li></ol><p><strong>场景四：典型的内存泄露到爆的场景</strong></p><p>为了显示我能力的多样性，我换个工具的监控结果。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage0cc60cd248b5d32fa7c6b2bb34f3c1332dc6.e7b994ec.png" alt=""/></p><p>看到上面这张图，你可能觉得人生面对着挑战：“啥玩意？”</p><p>实际上，这张图说明以下四点：</p><ol><li>年轻代（第三列）、年老代（第四列）全满了，持久代在不断增加，并且也没有释放过。</li><li>两个保留区（第一列、第二列）都是空的。</li><li>Yonug GC（第六列）已经不做了。</li><li>Full GC（第八列）一直都在尝试做回收的动作，但是一直也没成功，因为年轻代、年老代都没回收下来，持久代也在不停涨。</li></ol><p>如果出现了1和2的话，不用看什么具体对象内存的消耗，只要像网上那些只玩JVM参数的人一样，调调参数就行了。</p><p>但是如果出现3和4，对于3还要再判断一下，之前的内存是不是设置得太小了？如果是，就调大，看能不能到场景一的状态。如果不是，那就得像场景四一样，查一下内存到底消耗在哪个对象上了。</p><h3 id="查找增加的内存"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#查找增加的内存"><span class="icon icon-link"></span></a>查找增加的内存</h3><p><strong>逻辑一</strong></p><p>下面我们来说说如何判断性能测试过程中内存的变化。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage508e502a6ed2d254820ce92ab6bd22b2928e.9d8681c8.png" alt=""/></p><p>我们在内存中经常看到的对象是这样的。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimageed9eed0fbdbfa94a97380a86c7730b2db49e.1455730d.png" alt=""/></p><p>如果你用jmap的话，会看到如下信息。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagefe2bfec55fa1419b3e87be9e1d9adf06982b.80af8f44.png" alt=""/></p><p>你可能会问，这么多的内容，我到底要看什么呢？这也是性能测试人员经常遇到的问题，明明数据都在眼前，就是不知道从哪下嘴。</p><p>我建议你不要看这些底层的对象类型，因为实在是有点多哇。在这里我们最好是看自己代码调用的对象的内存占用大小增量。</p><ol><li>先过滤下我们自己的包。</li><li>点击一下Deltas，就能看到下面的截图。</li></ol><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimageb170b1373d88b3799c573d618545141dca70.aba8d6c2.png" alt=""/></p><p>在刚开始点击Deltas之后，会看到全是零的对象。</p><p>下面我们来做下压力，观察一下。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimageee40eebbb6e45916a8f3f4fb4f5c43538c40.72bb942f.png" alt=""/></p><p>你看现在对象的实体都在往上增加对吧？但是当压力停止之后，该回收的都回收了，而有些必须长久使用的对象，在架构设计上也应该清晰地判断增量，不然就有可能导致内存不够。出现这种情况一般是架构师的失职。像这类东西应该写到公司的代码规范里。</p><p>当内存正常回收之后，再观察Deltas，应该会看到大部分对象都回收了的状态。如下所示：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage74cc7438e6e9df188a85edc5906a22852fcc.a98c69a3.png" alt=""/></p><p>临时的对象也都清理了。 这就是正常的结果。</p><p>如果停止压力之后，又做了正常的FullGC回收了之后，还是像下面这样。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage736e73e145ffcad24c4b72bb5c33b92e8b6e.0e8c6d0e.png" alt=""/></p><p>那就显然有问题了。回收不了的对象就是典型的内存泄露了。</p><p><strong>逻辑二</strong></p><p>我们看下面这个图。这是jmap做出来的heapdump，然后用MAT打开的。</p><p>1.第一个可疑的内存泄露点占了466.4MB的内存。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimageac21ac38b7a41afa0b4eef5ea8282494a421.3adc47a2.png" alt=""/></p><p>2.找到内存消耗点的多的内容。如下所示。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagec7ecc77ccf1e96b1794987354fac146cc6ec.e2930a8d.png" alt=""/></p><p>这是一个实体bean。每个倒是不大，但是架不住有79万个。</p><p>3.看它对应的栈。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage0e1f0e7914173204f8609c45c24944655f1f.4c32f94a.png" alt=""/></p><p>就是一个数据库操作。</p><p>4.取出SQL，查看执行计划如下。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagefd8dfd1c9859d61fb9bc531b3a10449b318d.db30e2a7.png" alt=""/></p><p>这是曲线的SQL查询数据过多，导致内存不够用。这个不叫泄露，这是溢出。因为要是一个人查询，就可能没事嘛，但是多个人一起查了，才会出问题。从业务的代码实现的角度上说，这绝对是个有问题的设计逻辑。如果真是必须全表扫描的，你得规定这个功能怎么用呀。如果不用全表扫描，干嘛不做过滤呢？</p><p>其实在Java中查找内存消耗的手段还有很多。你喜欢怎么玩就怎么玩，只要找得到就好。我只是给两种我觉得常用又易用的方式。</p><h2 id="cc类应用查找方法执行时间"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#cc类应用查找方法执行时间"><span class="icon icon-link"></span></a>C/C++类应用查找方法执行时间</h2><p>对C/C++的应用来说，我们可以用google-perftools查找方法执行时间。当然，在这之时，你需要先安装配置好google-perftools和libunwind。</p><p>google-perftools是针对C/C++程序的性能分析工具。使用它，可以对CPU时间片、内存等系统资源的分配和使用进行分析。</p><p>使用步骤如下：</p><ol><li>编译目标程序，加入对 google-perftools 库的依赖。</li><li>运行目标程序，在代码中加入启动/终止剖析的开关。</li><li>将生成的结果通过剖析工具生成相应的调用图。</li></ol><p>你可以在代码中加入固定输出剖析数据的开关，当运行到某段代码时就会执行。当然你也可以在代码中只加入接收信号的功能，然后在运行的过程中，通过kill命令给正在运行的程序发送指令，从而控制开关。</p><p>我来举个例子。如果我们有一个函数f，我想知道它的执行效率。硬编码的方式就是在调用这个函数的前后加上剖析开关。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">ProfilerStart(&quot;test.prof&quot;);//开启性能分析</span></div><div class="token-line"><span class="token plain">    f();</span></div><div class="token-line"><span class="token plain">    ProfilerStop();//停止性能分析</span></div></pre></div><p>在程序编译之后，会在同目录生成一个叫a.out的可执行文件。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage54c454f34188238d4dad62f9fd1ed5fdf5c4.890d965d.png" alt=""/></p><p>执行这个文件，就会生成test.prof文件。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage427d42fa660a548ffdaf7a9f84e92a2bef7d.9a047eda.png" alt=""/></p><p>然后执行命令：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">pprof --pdf a.out test.prof &gt;test.pdf</span></div></pre></div><p>打开这个PDF就可以看到如下图：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagef658f69e0653da960428fb4f308578508758.123ce70d.png" alt=""/></p><p>你看到上面有很多只有地址而没有函数名的调用吗？那是没有符号表。这里我们不分析那些不是我们自己的函数，我们只看自己的函数f。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>看这一段，它有三行。</p><ul><li>第一行：函数名；</li><li>第二行：不包含内部函数调用的样本数 (百分比) ；</li><li>第三行：of 包含内部函数调用的样本数 (百分比)。</li></ul><p>是不是和Java中self time/total time有异曲同工之妙？它也可以实现从CPU使用率高到具体函数的定位。</p><p>你也许会说，这个有点复杂，还要在代码里加这么多，编译还要加上动态库啥的。当然了，你还可以用perf工具来跟踪CPU clock，在代码编译时加上调试参数，就可以直接用perf top -g看调用过程由每个函数所消耗的CPU时钟。你还可以用systemtap来自己写代码进行动态跟踪。</p><h2 id="cc类应用查找对象内存消耗"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#cc类应用查找对象内存消耗"><span class="icon icon-link"></span></a>C/C++类应用查找对象内存消耗</h2><p>其实googler perftools也可以分析内存，但是我觉得它没有Valgrind好使。所以在这一部分，我用valgrind来告诉你如何查找到C/C++的内存消耗。</p><p>valgrind能实现这些功能：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage60f86098d8b66b331a1791cc8daaeaa186f8.00c17648.png" alt=""/></p><p>这里举一个内存泄露的小例子。这是一段再无聊不过的代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">#include &lt;stdlib.h&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">      void f(void)</span></div><div class="token-line"><span class="token plain">      {</span></div><div class="token-line"><span class="token plain">         int* x = malloc(10 * sizeof(int));</span></div><div class="token-line"><span class="token plain">         x[10] = 0;        // problem 1: heap block overrun</span></div><div class="token-line"><span class="token plain">      }                    // problem 2: memory leak -- x not freed</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">      int main(void)</span></div><div class="token-line"><span class="token plain">      {</span></div><div class="token-line"><span class="token plain">         f();</span></div><div class="token-line"><span class="token plain">         return 0;</span></div></pre></div><p>我们不断分配，而不释放。</p><p>编译运行之后，我们可以看到如下结果。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[root@7dgroup Sample10]# gcc -Wall -o test5 test5.c </span></div><div class="token-line"><span class="token plain">    [root@7dgroup Sample10]# valgrind --tool=memcheck --leak-check=full ./test5</span></div><div class="token-line"><span class="token plain">    ==318== Memcheck, a memory error detector</span></div><div class="token-line"><span class="token plain">    ==318== Copyright (C) 2002-2013, and GNU GPL&#x27;d, by Julian Seward et al.</span></div><div class="token-line"><span class="token plain">    ==318== Using Valgrind-3.10.0 and LibVEX; rerun with -h for copyright info</span></div><div class="token-line"><span class="token plain">    ==318== Command: ./test5</span></div><div class="token-line"><span class="token plain">    ==318== </span></div><div class="token-line"><span class="token plain">    ==318== Invalid write of size 4</span></div><div class="token-line"><span class="token plain">    ==318==    at 0x40054E: f (in /root/GDB/Sample10/test5)</span></div><div class="token-line"><span class="token plain">    ==318==    by 0x40055E: main (in /root/GDB/Sample10/test5)</span></div><div class="token-line"><span class="token plain">    ==318==  Address 0x51f7068 is 0 bytes after a block of size 40 alloc&#x27;d</span></div><div class="token-line"><span class="token plain">    ==318==    at 0x4C29BFD: malloc (in /usr/lib64/valgrind/vgpreload_memcheck-amd64-linux.so)</span></div><div class="token-line"><span class="token plain">    ==318==    by 0x400541: f (in /root/GDB/Sample10/test5)</span></div><div class="token-line"><span class="token plain">    ==318==    by 0x40055E: main (in /root/GDB/Sample10/test5)</span></div><div class="token-line"><span class="token plain">    ==318== </span></div><div class="token-line"><span class="token plain">    ==318== </span></div><div class="token-line"><span class="token plain">    ==318== HEAP SUMMARY:</span></div><div class="token-line"><span class="token plain">    ==318==     in use at exit: 40 bytes in 1 blocks</span></div><div class="token-line"><span class="token plain">    ==318==   total heap usage: 1 allocs, 0 frees, 40 bytes allocated</span></div><div class="token-line"><span class="token plain">    ==318== </span></div><div class="token-line"><span class="token plain">    ==318== 40 bytes in 1 blocks are definitely lost in loss record 1 of 1</span></div><div class="token-line"><span class="token plain">    ==318==    at 0x4C29BFD: malloc (in /usr/lib64/valgrind/vgpreload_memcheck-amd64-linux.so)</span></div><div class="token-line"><span class="token plain">    ==318==    by 0x400541: f (in /root/GDB/Sample10/test5)</span></div><div class="token-line"><span class="token plain">    ==318==    by 0x40055E: main (in /root/GDB/Sample10/test5)</span></div><div class="token-line"><span class="token plain">    ==318== </span></div><div class="token-line"><span class="token plain">    ==318== LEAK SUMMARY:</span></div><div class="token-line"><span class="token plain">    ==318==    definitely lost: 40 bytes in 1 blocks</span></div><div class="token-line"><span class="token plain">    ==318==    indirectly lost: 0 bytes in 0 blocks</span></div><div class="token-line"><span class="token plain">    ==318==      possibly lost: 0 bytes in 0 blocks</span></div><div class="token-line"><span class="token plain">    ==318==    still reachable: 0 bytes in 0 blocks</span></div><div class="token-line"><span class="token plain">    ==318==         suppressed: 0 bytes in 0 blocks</span></div><div class="token-line"><span class="token plain">    ==318== </span></div><div class="token-line"><span class="token plain">    ==318== For counts of detected and suppressed errors, rerun with: -v</span></div><div class="token-line"><span class="token plain">    ==318== ERROR SUMMARY: 2 errors from 2 contexts (suppressed: 1 from 1)</span></div><div class="token-line"><span class="token plain">    [root@7dgroup Sample10]#</span></div></pre></div><p>主要看一下这行。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">==318==   total heap usage: 1 allocs, 0 frees, 40 bytes allocated</span></div></pre></div><p>这里分配了40个字节的一块内存，但是0释放，所以就泄露了。</p><p>请你注意，在调试自己的程序时，要像Java一样，分析内存的泄露，在压力前和压力后做内存的比对。在压力中则不用做。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#总结"><span class="icon icon-link"></span></a>总结</h2><p>不管是什么语言的应用，在性能分析的过程中，都是分析两个方法。</p><ol><li>执行速度够不够快。只有够快才能满足更高的TPS。</li><li>执行过程中内存用得多不多。内存用得少，才可以同时支持更多的请求。</li></ol><p>我觉得对性能测试过程中的分析来说，这两点足够你解决代码上的问题了。有人说，为什么不说I/O的事情呢。其实I/O仍然是读写量的多少，也会反应用内存中。至于磁盘本身性能跟不上，那是另一个话题。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-test/性能测试实战30讲/05.第三模块性能监控分析工具篇/05#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>最后给你留两个思考题吧。对代码的性能分析过程中，主要是哪两点呢？针对代码分析的这两点，有什么样的分析链路？</p><p>欢迎你在评论区写下自己的思考，也欢迎把这篇文章分享给你的朋友或者同事，一起交流一下。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/性能测试实战30讲/05.第三模块性能监控分析工具篇/05.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 22:08:02</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-test/umi.js"></script>
  </body>
</html>
